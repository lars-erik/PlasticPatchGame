<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
    <style>
        body { margin: 0; overflow: hidden; }
        canvas { width: 100%; height: 100% }
    </style>
</head>
<body>
    <script src="node_modules/three/build/three.js"></script>
    <script src="scripts/perlin.js"></script>
<script>

    var scene = new THREE.Scene();
    var camera = new THREE.PerspectiveCamera(90, window.innerWidth / window.innerHeight, 1, 1000);
    var vFOV = THREE.Math.degToRad(camera.fov); // convert vertical fov to radians
    var height = 2 * Math.tan(vFOV / 2) * 100; // visible height
    var width = height * camera.aspect;           // visible width
    var lookatX = width / 2;
    var lookatY = height / 2;
    var noiseSize = 5;
    var noiseSet = new noise.perlin(noiseSize);
    var noiseScale = noiseSize / width;

    var gridUnit = width / 20;

    var renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    camera.position.set(lookatX, lookatY, 100);
    camera.lookAt(new THREE.Vector3(lookatX, lookatY, 0));

    var material = new THREE.LineBasicMaterial({ color: 0xffffff });

    scene.background = new THREE.Color(0x000088);

    function Trash(scene) {
        let geometry = new THREE.Geometry();
        let points = 3 + parseInt(Math.random() * 3);
        let angles = [];
        for (let i = 0; i < points; i++) {
            angles.push(Math.random() * Math.PI * 2);
        }
        angles.sort();
        for (let i = 0; i < points; i++) {
            geometry.vertices.push(new THREE.Vector3(Math.cos(angles[i]), Math.sin(angles[i], 0.1)));
        }
        geometry.vertices.push(geometry.vertices[0]);

        this.line = new THREE.Line(geometry, material);
        this.line.scale.set(3, 3, 0.1);

        scene.add(this.line);

        this.line.position.set(-10, height / 2 + (Math.random() * height / 5) - (height / 10 * Math.random()), 0);
        this.vector = new THREE.Vector3(.001, Math.random() * height, 0);

        this.update = function() {
            var ang = Math.atan(this.vector.y);
            var force = noiseSet.noise([Math.abs(this.line.position.x * noiseScale), Math.abs(this.line.position.y * noiseScale)]);
            var newAng = ang + force;
            var newVector = new THREE.Vector3(Math.sin(newAng) * .1, Math.cos(newAng) * -.1, 0);
            this.line.position.add(newVector);
        }
    }

    var allTrash = [];
    allTrash.push(new Trash(scene));

    var chance = 0.005;

    setInterval(function() {
        chance += 0.0001;

        console.log(chance);
    }, 300);

    var animate = function () {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);

        if (Math.random() <= chance) {
            for (let i = 0; i < Math.random() * 2; i++) {
                allTrash.push(new Trash(scene));
                console.log("added trash");
            }
        }

        for (let i = allTrash.length - 1; i >= 0; i--) {
            allTrash[i].update();

            if (allTrash[i].line.position.x > width + 10) {
                let trash = allTrash[i];
                scene.remove(trash.line);
                allTrash.splice(i, 0);
                delete trash;
            }
        }
    };

    animate();

</script>
</body>
</html>